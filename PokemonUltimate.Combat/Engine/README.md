# Combat Engine

The core engine that orchestrates battle execution. This module contains the main battle controllers and the step-based execution pipelines.

## Components

### CombatEngine (`CombatEngine.cs`)

The main controller for battle execution. Orchestrates the full battle lifecycle from initialization to completion.

**Responsibilities:**

-   Battle initialization with parties and action providers
-   Battle flow execution (setup → loop → cleanup)
-   Dependency management (damage pipeline, handlers, validators)
-   Battle state tracking (field, queue, outcome)

**Key Methods:**

-   `Initialize()`: Sets up the battle with parties and providers
-   `RunBattle()`: Executes the complete battle until conclusion
-   `RunTurn()`: Executes a single turn (for step-by-step execution)

### TurnEngine (`TurnEngine.cs`)

Executes individual battle turns using a modular step-based pipeline. Coordinates 23 distinct steps in the correct order.

**Responsibilities:**

-   Turn execution coordination
-   Step pipeline management
-   Turn context creation and management

**Key Methods:**

-   `ExecuteTurn()`: Executes a single turn through the step pipeline

## Architecture

The engine uses a **two-level step architecture**:

### Battle Flow (`BattleFlow/`)

High-level battle lifecycle steps:

| #   | Step                             | Purpose                                          |
| --- | -------------------------------- | ------------------------------------------------ |
| 1   | **CreateFieldStep.cs**           | Creates BattleField with both sides              |
| 2   | **AssignActionProvidersStep.cs** | Assigns action providers to battle sides         |
| 3   | **CreateQueueStep.cs**           | Creates BattleQueueService for action processing |
| 4   | **ValidateInitialStateStep.cs**  | Validates initial battle state (parties, rules)  |
| 5   | **CreateDependenciesStep.cs**    | Creates TurnEngine and runtime dependencies      |
| 6   | **BattleStartFlowStep.cs**       | Executes battle start effects (abilities, items) |
| 7   | **ExecuteBattleLoopStep.cs**     | Executes main battle loop until completion       |
| 8   | **BattleEndFlowStep.cs**         | Handles battle end (statistics, cleanup, result) |

See `BattleFlow/Steps/README.md` for detailed step documentation.

### Turn Flow (`TurnFlow/`)

Detailed turn execution steps (23 unique steps, 34 total including ProcessGeneratedActionsStep repetitions):

| Phase                   | #   | Step                               | Purpose                                                         |
| ----------------------- | --- | ---------------------------------- | --------------------------------------------------------------- |
| **Preparation**         | 1   | **TurnStartStep.cs**               | Initializes turn context, resets turn-specific state            |
|                         | 2   | **ActionCollectionStep.cs**        | Collects actions from all active slots' action providers        |
|                         | 3   | **TargetResolutionStep.cs**        | Resolves move targets and applies redirection effects           |
|                         | 4   | **ActionSortingStep.cs**           | Sorts actions by priority and speed for execution order         |
| **Move Validation**     | 5   | **MoveValidationStep.cs**          | Validates moves (PP, status, charging states)                   |
|                         | 6   | **MoveProtectionCheckStep.cs**     | Checks for protection effects (Protect, Detect, etc.)           |
|                         | 7   | **MoveAccuracyCheckStep.cs**       | Checks move accuracy and determines if moves hit                |
| **Before Move Effects** | 8   | **BeforeMoveEffectsStep.cs**       | Processes abilities/items that trigger before moves             |
|                         | 9   | **ProcessGeneratedActionsStep.cs** | Processes actions generated by before-move effects              |
| **Damage Calculation**  | 10  | **MoveDamageCalculationStep.cs**   | Calculates damage for all moves using damage pipeline           |
| **Damage Application**  | 11  | **MoveDamageApplicationStep.cs**   | Applies calculated damage to targets                            |
|                         | 12  | **ProcessGeneratedActionsStep.cs** | Processes damage actions and fainting reactions                 |
| **Move Animations**     | 13  | **MoveAnimationStep.cs**           | Executes move animations and visual presentation                |
| **Reactive Effects**    | 14  | **DamageTakenEffectsStep.cs**      | Processes effects triggered by taking damage                    |
|                         | 15  | **ContactReceivedEffectsStep.cs**  | Processes contact-based effects (Static, Rocky Helmet, etc.)    |
|                         | 16  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by reactive effects                 |
| **Move Effects**        | 17  | **MoveEffectProcessingStep.cs**    | Processes move effects (status, stat changes, recoil, etc.)     |
|                         | 18  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by move effects                     |
| **After Move Effects**  | 19  | **AfterMoveEffectsStep.cs**        | Processes abilities/items that trigger after moves              |
|                         | 20  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by after-move effects               |
| **Other Actions**       | 21  | **SwitchActionsStep.cs**           | Processes Pokemon switch actions                                |
|                         | 22  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by switches                         |
|                         | 23  | **SwitchInEffectsStep.cs**         | Processes entry effects (Intimidate, entry hazards)             |
|                         | 24  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by entry effects                    |
|                         | 25  | **StatusActionsStep.cs**           | Processes status-related actions (damage, healing)              |
|                         | 26  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by status effects                   |
| **Fainted Check**       | 27  | **FaintedPokemonCheckStep.cs**     | Checks for and handles fainted Pokemon                          |
| **End of Turn**         | 28  | **EndOfTurnEffectsStep.cs**        | Processes end-of-turn effects (status damage, weather, terrain) |
|                         | 29  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by end-of-turn effects              |
|                         | 30  | **FaintedPokemonCheckStep.cs**     | Checks for fainted Pokemon after end-of-turn effects            |
|                         | 31  | **DurationDecrementStep.cs**       | Decrements durations (weather, terrain, status, etc.)           |
|                         | 32  | **TurnEndStep.cs**                 | Finalizes turn, processes turn-end abilities/items              |
|                         | 33  | **ProcessGeneratedActionsStep.cs** | Processes final turn-end actions                                |
|                         | 34  | **FaintedPokemonCheckStep.cs**     | Final check for fainted Pokemon                                 |

See `TurnFlow/Steps/README.md` for detailed step documentation.

## Context Objects

### BattleFlowContext (`BattleFlow/BattleFlowContext.cs`)

Mutable context that flows through battle flow steps. Contains:

-   Input parameters (rules, parties, providers)
-   Created components (field, queue, turn engine)
-   Battle state (outcome, result)
-   Dependencies (validators, loggers, resolvers)

### TurnContext (`TurnFlow/TurnContext.cs`)

Mutable context that flows through turn flow steps. Contains:

-   Battle field reference
-   Queue service reference
-   Collected and sorted actions
-   Validation results (move validations, accuracy checks, protection checks)
-   Damage calculations
-   Generated actions to process
-   Processed actions tracking

## Step Execution

Both battle flow and turn flow use the same pattern:

1. **Step Interface**: `IBattleFlowStep` or `ITurnStep`
2. **Step Executor**: `BattleFlowExecutor` or `TurnStepExecutor`
3. **Context Passing**: Context flows through all steps
4. **Validation**: State validation between steps
5. **Logging**: Step execution logging

## Dependencies

The engine requires:

-   **BattleFieldFactory**: Creates battlefield instances
-   **BattleQueueFactory**: Creates action queue instances
-   **IRandomProvider**: Random number generation
-   **IDamagePipeline**: Damage calculation pipeline
-   **CombatEffectHandlerRegistry**: Unified handler registry
-   **AccuracyChecker**: Move accuracy validation
-   **TargetResolver**: Target resolution
-   **IBattleStateValidator**: State validation
-   **IBattleLogger**: Battle logging
-   **IBattleView**: Visual presentation

## Usage Example

```csharp
// Create engine with dependencies
var engine = new CombatEngine(
    battleFieldFactory,
    battleQueueFactory,
    randomProvider,
    accuracyChecker,
    damagePipeline,
    handlerRegistry
);

// Initialize battle
engine.Initialize(
    rules,
    playerParty,
    enemyParty,
    playerProvider,
    enemyProvider,
    view
);

// Run battle
var result = await engine.RunBattle();
```

## Extension Points

### Adding New Turn Steps

1. Implement `ITurnStep` interface
2. Add step to `TurnEngine` constructor step list
3. Update `TurnContext` if new context data is needed

### Adding New Battle Flow Steps

1. Implement `IBattleFlowStep` interface
2. Add step to `CombatEngine.Initialize()` step list
3. Update `BattleFlowContext` if new context data is needed

## Related Documentation

-   `TurnFlow/Steps/README.md` - Turn step documentation
-   `BattleFlow/Steps/README.md` - Battle flow step documentation
-   `../Actions/README.md` - Action system
-   `../Handlers/README.md` - Handler system
-   `../Damage/README.md` - Damage pipeline
