# Turn Flow Steps

This directory contains all 23 steps that execute during a single battle turn. Steps are executed sequentially in the order defined in `TurnEngine.cs`.

## Complete Step List

### Phase 1: Preparation

| #   | Step                        | Purpose                                                                 |
| --- | --------------------------- | ----------------------------------------------------------------------- |
| 1   | **TurnStartStep.cs**        | Initializes turn context, resets turn-specific state                    |
| 2   | **ActionCollectionStep.cs** | Collects actions from all active slots' action providers                |
| 3   | **TargetResolutionStep.cs** | Resolves move targets and applies redirection effects (Follow Me, etc.) |
| 4   | **ActionSortingStep.cs**    | Sorts actions by priority and speed for execution order                 |

### Phase 2: Move Validation

| #   | Step                           | Purpose                                               |
| --- | ------------------------------ | ----------------------------------------------------- |
| 5   | **MoveValidationStep.cs**      | Validates moves (PP, status, charging states)         |
| 6   | **MoveProtectionCheckStep.cs** | Checks for protection effects (Protect, Detect, etc.) |
| 7   | **MoveAccuracyCheckStep.cs**   | Checks move accuracy and determines if moves hit      |

### Phase 3: Before Move Effects

| #   | Step                               | Purpose                                             |
| --- | ---------------------------------- | --------------------------------------------------- |
| 8   | **BeforeMoveEffectsStep.cs**       | Processes abilities/items that trigger before moves |
| 9   | **ProcessGeneratedActionsStep.cs** | Processes actions generated by before-move effects  |

### Phase 4: Damage Calculation

| #   | Step                             | Purpose                                               |
| --- | -------------------------------- | ----------------------------------------------------- |
| 10  | **MoveDamageCalculationStep.cs** | Calculates damage for all moves using damage pipeline |

### Phase 5: Damage Application

| #   | Step                               | Purpose                                         |
| --- | ---------------------------------- | ----------------------------------------------- |
| 11  | **MoveDamageApplicationStep.cs**   | Applies calculated damage to targets            |
| 12  | **ProcessGeneratedActionsStep.cs** | Processes damage actions and fainting reactions |

### Phase 5.5: Move Animations

| #   | Step                     | Purpose                                          |
| --- | ------------------------ | ------------------------------------------------ |
| 13  | **MoveAnimationStep.cs** | Executes move animations and visual presentation |

### Phase 6: Reactive Effects

| #   | Step                               | Purpose                                                      |
| --- | ---------------------------------- | ------------------------------------------------------------ |
| 14  | **DamageTakenEffectsStep.cs**      | Processes effects triggered by taking damage                 |
| 15  | **ContactReceivedEffectsStep.cs**  | Processes contact-based effects (Static, Rocky Helmet, etc.) |
| 16  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by reactive effects              |

### Phase 7: Move Effects

| #   | Step                               | Purpose                                                     |
| --- | ---------------------------------- | ----------------------------------------------------------- |
| 17  | **MoveEffectProcessingStep.cs**    | Processes move effects (status, stat changes, recoil, etc.) |
| 18  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by move effects                 |

### Phase 8: After Move Effects

| #   | Step                               | Purpose                                            |
| --- | ---------------------------------- | -------------------------------------------------- |
| 19  | **AfterMoveEffectsStep.cs**        | Processes abilities/items that trigger after moves |
| 20  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by after-move effects  |

### Phase 9: Other Actions

| #   | Step                               | Purpose                                             |
| --- | ---------------------------------- | --------------------------------------------------- |
| 21  | **SwitchActionsStep.cs**           | Processes Pokemon switch actions                    |
| 22  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by switches             |
| 23  | **SwitchInEffectsStep.cs**         | Processes entry effects (Intimidate, entry hazards) |
| 24  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by entry effects        |
| 25  | **StatusActionsStep.cs**           | Processes status-related actions (damage, healing)  |
| 26  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by status effects       |

### Phase 10: Fainted Pokemon Check

| #   | Step                           | Purpose                                |
| --- | ------------------------------ | -------------------------------------- |
| 27  | **FaintedPokemonCheckStep.cs** | Checks for and handles fainted Pokemon |

### Phase 11: End of Turn

| #   | Step                               | Purpose                                                         |
| --- | ---------------------------------- | --------------------------------------------------------------- |
| 28  | **EndOfTurnEffectsStep.cs**        | Processes end-of-turn effects (status damage, weather, terrain) |
| 29  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by end-of-turn effects              |
| 30  | **FaintedPokemonCheckStep.cs**     | Checks for fainted Pokemon after end-of-turn effects            |
| 31  | **DurationDecrementStep.cs**       | Decrements durations (weather, terrain, status, etc.)           |
| 32  | **TurnEndStep.cs**                 | Finalizes turn, processes turn-end abilities/items              |
| 33  | **ProcessGeneratedActionsStep.cs** | Processes final turn-end actions                                |
| 34  | **FaintedPokemonCheckStep.cs**     | Final check for fainted Pokemon                                 |

## Step Interface

All steps implement `ITurnStep`:

```csharp
public interface ITurnStep
{
    string StepName { get; }
    bool ExecuteEvenIfFainted { get; }
    Task<bool> ExecuteAsync(TurnContext context);
}
```

## Context Usage

Steps read from and write to `TurnContext`:

**Read:**

-   `Field`: Battle field reference
-   `QueueService`: Action queue service
-   `CollectedActions`: Actions collected from providers
-   `SortedActions`: Actions sorted by priority/speed
-   `MoveValidations`: Move validation results
-   `AccuracyChecks`: Accuracy check results
-   `ProtectionChecks`: Protection check results
-   `DamageCalculations`: Damage calculation results

**Write:**

-   `MoveValidations`: Store validation results
-   `AccuracyChecks`: Store accuracy check results
-   `ProtectionChecks`: Store protection check results
-   `DamageCalculations`: Store damage calculations
-   `GeneratedActions`: Add generated actions
-   `ProcessedActions`: Track processed actions
-   `HasFaintedPokemon`: Set fainting flag

## How to Add a New Turn Step

### Step 1: Create the Step Class

Create a new file in `Engine/TurnFlow/Steps/` (e.g., `CustomEffectStep.cs`):

```csharp
using System.Threading.Tasks;
using PokemonUltimate.Combat.Engine.TurnFlow;
using PokemonUltimate.Combat.Engine.TurnFlow.Definition;

namespace PokemonUltimate.Combat.Engine.TurnFlow.Steps
{
    public class CustomEffectStep : ITurnStep
    {
        public string StepName => "Custom Effect";
        public bool ExecuteEvenIfFainted => false;

        public async Task<bool> ExecuteAsync(TurnContext context)
        {
            // Your step logic here
            // Read from context
            // Write to context
            // Generate actions if needed

            return await Task.FromResult(true);
        }
    }
}
```

### Step 2: Add Step to TurnEngine

Open `Engine/TurnEngine.cs` and add your step to the step list in the constructor:

```csharp
var steps = new List<ITurnStep>
{
    // ... existing steps ...

    // Add your step in the appropriate phase
    new CustomEffectStep(),

    // ... rest of steps ...
};
```

**Important**: Place your step in the correct execution order based on when it should run.

### Step 3: Update TurnContext (if needed)

If your step needs new context data, update `Engine/TurnFlow/TurnContext.cs`:

```csharp
public class TurnContext
{
    // ... existing properties ...

    // Add new property for your step
    public Dictionary<SomeType, SomeValue> CustomData { get; set; }
        = new Dictionary<SomeType, SomeValue>();
}
```

### Step 4: Test Your Step

Create unit tests for your step:

```csharp
[Test]
public async Task CustomEffectStep_ProcessesEffect()
{
    // Arrange
    var step = new CustomEffectStep();
    var context = CreateTestTurnContext();

    // Act
    var result = await step.ExecuteAsync(context);

    // Assert
    Assert.IsTrue(result);
    // Verify expected behavior
}
```

## Design Principles

1. **Single Responsibility**: Each step handles one specific aspect of turn execution
2. **Decoupling**: Steps communicate only through context, not directly
3. **Reusability**: `ProcessGeneratedActionsStep` is reused multiple times
4. **Testability**: Each step can be tested independently
5. **Extensibility**: New steps can be added without modifying existing ones
6. **Order Matters**: Step execution order is critical for correct battle flow

## Common Patterns

### Generating Actions

```csharp
// Generate actions
var actions = new List<BattleAction>();
actions.Add(new SomeAction(slot, target));
context.GeneratedActions.AddRange(actions);
```

### Reading from Context

```csharp
// Read validation results
if (context.MoveValidations.TryGetValue(moveAction, out bool isValid))
{
    if (isValid)
    {
        // Process valid move
    }
}
```

### Writing to Context

```csharp
// Store calculation results
context.DamageCalculations[moveAction] = damageContext;
```

## Related Documentation

-   `../TurnContext.cs` - Turn context structure
-   `../TurnStepExecutor.cs` - Step execution engine
-   `../../README.md` - Engine overview
-   `../../../Actions/README.md` - Action system
-   `../../../Handlers/README.md` - Handler system
