# Feature 2: Combat System - Architecture

> Complete technical specification of the Pokemon battle engine.

**Feature Number**: 2  
**Feature Name**: Combat System  
**See**: [`../../features_master_list.md`](../../features_master_list.md) for feature numbering standards.

## 1. Core Philosophy: "Step-Based Pipeline Architecture"

The combat system uses a **step-based pipeline architecture** that separates concerns and makes the system highly modular and testable:

-   **Battle Flow**: High-level battle lifecycle (8 steps: setup → execution → cleanup)
-   **Turn Flow**: Detailed turn execution (23 unique steps, 34 total including repetitions)
-   **Damage Pipeline**: Modular damage calculation (11 steps)
-   **Action System**: Command pattern for battle actions (13 action types)
-   **Handler Registry**: Unified system for abilities, items, and move effects (34 handlers)

The entire battle execution flows through these pipelines, with each step handling a specific responsibility. Actions are generated by steps and processed by the queue system.

## 2. The Action Queue System

### `BattleAction` (Abstract Class)

The base unit of work.

```csharp
public abstract class BattleAction {
    // Phase 1: Logic (Instant)
    // Updates the data model (HP, Status, etc.)
    // Returns new Actions triggered by this one (e.g., Damage -> Faint)
    public abstract IEnumerable<BattleAction> ExecuteLogic(BattleField field);

    // Phase 2: Visual (Async)
    // Shows the animation, text, or UI update.
    public abstract Task ExecuteVisual(IBattleView view);
}
```

### `BattleQueue` (Controller)

Manages the flow.

```csharp
public class BattleQueue {
    private Queue<BattleAction> _queue = new Queue<BattleAction>();

    public async Task ProcessQueue(BattleField field, IBattleView view) {
        int safetyCounter = 0;
        while (_queue.Count > 0) {
            if (safetyCounter++ > 1000) throw new Exception("Infinite Loop in Battle Queue!");

            var action = _queue.Dequeue();

            // 1. Run Logic
            var reactions = action.ExecuteLogic(field);

            // 2. Run Visual (Wait for it)
            // This handles Animations, Text, and Audio via IBattleView
            await action.ExecuteVisual(view);

            // 3. Enqueue reactions (Priority: Immediate)
            InsertAtFront(reactions);
        }
    }
}
```

> [!NOTE]
> Actions can be purely visual/audio (e.g., `PlaySoundAction`, `MessageAction`). These actions return no logic reactions but are critical for player feedback. See `ui_presentation_system.md`.

### Event Triggers (Abilities & Items)

After processing actions, the engine fires event triggers for Abilities and Items.

```csharp
// Example: At end of turn
await ProcessTriggers(BattleTrigger.OnTurnEnd);

private async Task ProcessTriggers(BattleTrigger trigger) {
    foreach (var slot in field.GetAllActiveSlots()) {
        if (slot.Pokemon.Item != null) {
            var actions = slot.Pokemon.Item.OnTrigger(trigger, slot, field);
            foreach (var action in actions) _queue.Enqueue(action);
        }
        if (slot.Pokemon.Ability != null) {
            var actions = slot.Pokemon.Ability.OnTrigger(trigger, slot, field);
            foreach (var action in actions) _queue.Enqueue(action);
        }
    }
    await _queue.ProcessQueue(field, view);
}
```

## 3. Battle Configuration (Modes: 1v1, 2v2, 1v3)

To support any battle type, we pass a `BattleRules` object when starting combat.

```csharp
public class BattleRules {
    public int PlayerSideSlots { get; set; } = 1; // Standard: 1
    public int EnemySideSlots { get; set; } = 1;  // Standard: 1
    // 1v3 Horde: Player=1, Enemy=3
    // 2v2 Double: Player=2, Enemy=2
    // Boss: Player=1, Enemy=1 (but Enemy has Boss Stats)
}

public void InitializeBattle(BattleRules rules, Party playerParty, Party enemyParty) {
    // Setup slots dynamically based on rules
    _field.SetupSides(rules.PlayerSideSlots, rules.EnemySideSlots);
    // Spawn pokemon into slots...
}
```

## 3. Step-Based Pipeline Architecture

### Battle Flow (8 Steps)

High-level battle lifecycle managed by `CombatEngine`:

| #   | Step                             | Purpose                                          |
| --- | -------------------------------- | ------------------------------------------------ |
| 1   | **CreateFieldStep.cs**           | Creates BattleField with both sides              |
| 2   | **AssignActionProvidersStep.cs** | Assigns action providers to battle sides         |
| 3   | **CreateQueueStep.cs**           | Creates BattleQueueService for action processing |
| 4   | **ValidateInitialStateStep.cs**  | Validates initial battle state (parties, rules)  |
| 5   | **CreateDependenciesStep.cs**    | Creates TurnEngine and runtime dependencies      |
| 6   | **BattleStartFlowStep.cs**       | Executes battle start effects (abilities, items) |
| 7   | **ExecuteBattleLoopStep.cs**     | Executes main battle loop until completion       |
| 8   | **BattleEndFlowStep.cs**         | Handles battle end (statistics, cleanup, result) |

### Turn Flow (23 Unique Steps, 34 Total)

Detailed turn execution managed by `TurnEngine`:

| Phase                   | #   | Step                               | Purpose                                                         |
| ----------------------- | --- | ---------------------------------- | --------------------------------------------------------------- |
| **Preparation**         | 1   | **TurnStartStep.cs**               | Initializes turn context, resets turn-specific state            |
|                         | 2   | **ActionCollectionStep.cs**        | Collects actions from all active slots' action providers        |
|                         | 3   | **TargetResolutionStep.cs**        | Resolves move targets and applies redirection effects           |
|                         | 4   | **ActionSortingStep.cs**           | Sorts actions by priority and speed for execution order         |
| **Move Validation**     | 5   | **MoveValidationStep.cs**          | Validates moves (PP, status, charging states)                   |
|                         | 6   | **MoveProtectionCheckStep.cs**     | Checks for protection effects (Protect, Detect, etc.)           |
|                         | 7   | **MoveAccuracyCheckStep.cs**       | Checks move accuracy and determines if moves hit                |
| **Before Move Effects** | 8   | **BeforeMoveEffectsStep.cs**       | Processes abilities/items that trigger before moves             |
|                         | 9   | **ProcessGeneratedActionsStep.cs** | Processes actions generated by before-move effects              |
| **Damage Calculation**  | 10  | **MoveDamageCalculationStep.cs**   | Calculates damage for all moves using damage pipeline           |
| **Damage Application**  | 11  | **MoveDamageApplicationStep.cs**   | Applies calculated damage to targets                            |
|                         | 12  | **ProcessGeneratedActionsStep.cs** | Processes damage actions and fainting reactions                 |
| **Move Animations**     | 13  | **MoveAnimationStep.cs**           | Executes move animations and visual presentation                |
| **Reactive Effects**    | 14  | **DamageTakenEffectsStep.cs**      | Processes effects triggered by taking damage                    |
|                         | 15  | **ContactReceivedEffectsStep.cs**  | Processes contact-based effects (Static, Rocky Helmet, etc.)    |
|                         | 16  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by reactive effects                 |
| **Move Effects**        | 17  | **MoveEffectProcessingStep.cs**    | Processes move effects (status, stat changes, recoil, etc.)     |
|                         | 18  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by move effects                     |
| **After Move Effects**  | 19  | **AfterMoveEffectsStep.cs**        | Processes abilities/items that trigger after moves              |
|                         | 20  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by after-move effects               |
| **Other Actions**       | 21  | **SwitchActionsStep.cs**           | Processes Pokemon switch actions                                |
|                         | 22  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by switches                         |
|                         | 23  | **SwitchInEffectsStep.cs**         | Processes entry effects (Intimidate, entry hazards)             |
|                         | 24  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by entry effects                    |
|                         | 25  | **StatusActionsStep.cs**           | Processes status-related actions (damage, healing)              |
|                         | 26  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by status effects                   |
| **Fainted Check**       | 27  | **FaintedPokemonCheckStep.cs**     | Checks for and handles fainted Pokemon                          |
| **End of Turn**         | 28  | **EndOfTurnEffectsStep.cs**        | Processes end-of-turn effects (status damage, weather, terrain) |
|                         | 29  | **ProcessGeneratedActionsStep.cs** | Processes actions generated by end-of-turn effects              |
|                         | 30  | **FaintedPokemonCheckStep.cs**     | Checks for fainted Pokemon after end-of-turn effects            |
|                         | 31  | **DurationDecrementStep.cs**       | Decrements durations (weather, terrain, status, etc.)           |
|                         | 32  | **TurnEndStep.cs**                 | Finalizes turn, processes turn-end abilities/items              |
|                         | 33  | **ProcessGeneratedActionsStep.cs** | Processes final turn-end actions                                |
|                         | 34  | **FaintedPokemonCheckStep.cs**     | Final check for fainted Pokemon                                 |

**Note**: `ProcessGeneratedActionsStep` appears multiple times (steps 9, 12, 16, 18, 20, 22, 24, 26, 29, 33) to process actions generated at different phases. `FaintedPokemonCheckStep` appears 3 times (steps 27, 30, 34) to check for fainting at critical points.

## 4. Examples of Actions

### `DamageAction` (Core Logic)

```csharp
public class DamageAction : BattleAction {
    private BattleSlot _target;
    private int _amount;

    public override IEnumerable<BattleAction> ExecuteLogic(BattleField field) {
        _target.Pokemon.CurrentHP -= _amount;

        // Check for Faint reaction
        if (_target.Pokemon.CurrentHP <= 0) {
            return new List<BattleAction> { new FaintAction(_target) };
        }
        return Enumerable.Empty<BattleAction>();
    }

    public override async Task ExecuteVisual(IBattleView view) {
        await view.PlayDamageAnimation(_target);
        await view.UpdateHPBar(_target); // Smooth drain
    }
}
```

### `UseMoveAction` (The Trigger & Conditional Logic)

```csharp
public class UseMoveAction : BattleAction {
    private BattleSlot _user;
    private MoveData _move;
    private BattleSlot _target;

    public override IEnumerable<BattleAction> ExecuteLogic(BattleField field) {
        // 1. Check Volatile Status (Flinch, Confusion, Sleep)
        if (_user.Pokemon.VolatileStatus.HasFlag(VolatileStatus.Flinch)) {
             _user.Pokemon.RemoveVolatile(VolatileStatus.Flinch); // Consume it
             return new List<BattleAction> { new MessageAction($"{_user.Pokemon.Name} flinched!") };
        }

        // 2. If we passed checks, generate the move actions
        var actions = new List<BattleAction>();
        actions.Add(new MessageAction($"{_user.Pokemon.Name} used {_move.Name}!"));
        actions.Add(new MoveAnimationAction(_user, _target, _move.VisualId));

        int damage = DamageCalculator.Calculate(_user, _target, _move);
        actions.Add(new DamageAction(_target, damage));

        if (_move.HasStatusEffect) {
             actions.Add(new StatusRollAction(_target, _move.StatusEffect, _move.StatusChance));
        }

        return actions;
    }

    public override Task ExecuteVisual(IBattleView view) {
        return Task.CompletedTask;
    }
}
```

## 5. Trace Example: Flinch Interaction (Retroceso)

Scenario: Pokemon A uses "Headbutt" (Causes Flinch). Pokemon B is slower.

1.  **`UseMoveAction(A)`** executes.
    -   Spawns `DamageAction` + `ApplyVolatileAction(B, Flinch)`.
2.  **`DamageAction`** executes. B takes damage.
3.  **`ApplyVolatileAction`** executes.
    -   _Logic_: Sets `B.VolatileStatus |= Flinch`.
    -   _Visual_: None (or small icon).
4.  **`UseMoveAction(B)`** (which was already in the queue) finally executes.
    -   _Logic_: Checks `if (B.HasFlag(Flinch))`. **TRUE**.
    -   _Result_: Returns ONLY `[MessageAction("B flinched!")]`.
    -   _Note_: The Damage/Animation for B's move are NEVER created. The turn ends.

## 6. Verification against Pillars

### Is it Simple?

-   **Yes.** The flow is linear. No complex state machines jumping around. Just a list of things to do.
-   **Safety**: Added a loop counter to prevent infinite reaction chains.

### Is it Readable?

-   **Yes.** `UseMoveAction` clearly lists what happens: Message -> Animation -> Damage. Anyone can read it and understand the move's sequence.

### Is it Modular?

-   **Yes.**
    -   Want to add **Weather**? Create `WeatherDamageAction`.
    -   Want to add **Dialogue** mid-fight? Create `DialogueAction`.
    -   Want to add **Tutorial Popups**? Create `TutorialAction`.
    -   None of these require changing the `CombatEngine` code.

### Is it Testable?

-   **Yes.**
    -   **Logic Tests**: Enqueue `DamageAction`, call `ExecuteLogic`, assert HP.
    -   **Visual Tests**: Mock `IBattleView`, run queue, assert that `PlayAnimation` was called.
    -   **Scenario Tests**: Setup a 1v3 battle (via `BattleRules`), enqueue an Area of Effect move, verify 3 enemies took damage.

---

## 4. Battle Mechanics Catalog

This section catalogs **all BattleActions, IMoveEffects, and Data Types** needed to support authentic Pokémon combat mechanics. Each entry follows the "Everything is an Action" pattern.

### 4.1 Core BattleActions

#### Damage & HP

| Action                | Description                  | Example                   |
| --------------------- | ---------------------------- | ------------------------- |
| `DamageAction`        | Standard damage application  | All damaging moves        |
| `FixedDamageAction`   | Fixed amount (ignores stats) | Seismic Toss, Dragon Rage |
| `PercentDamageAction` | % of target's max HP         | Super Fang (50%)          |
| `HealAction`          | Restore HP                   | Synthesis, Moonlight      |
| `RecoilDamageAction`  | User takes % of damage dealt | Double-Edge, Brave Bird   |
| `DrainAction`         | Damage + heal user           | Giga Drain, Drain Punch   |

#### Status & Stats

| Action              | Description            | Example                 |
| ------------------- | ---------------------- | ----------------------- |
| `ApplyStatusAction` | Apply major status     | Burn, Paralysis, Sleep  |
| `CureStatusAction`  | Remove status          | Heal Bell, Aromatherapy |
| `StatChangeAction`  | Modify stat stages     | Swords Dance (+2 Atk)   |
| `StatResetAction`   | Reset all stat changes | Haze, Clear Smog        |
| `StatSwapAction`    | Swap stat stages       | Psych Up, Guard Swap    |

#### Field & Environment

| Action                 | Description       | Example                 |
| ---------------------- | ----------------- | ----------------------- |
| `SetWeatherAction`     | Change weather    | Rain Dance, Sunny Day   |
| `SetTerrainAction`     | Change terrain    | Electric Terrain        |
| `SetFieldEffectAction` | Room effects      | Trick Room, Wonder Room |
| `SetHazardAction`      | Entry hazards     | Stealth Rock, Spikes    |
| `SetScreenAction`      | Defensive screens | Reflect, Light Screen   |

#### Control & Utility

| Action          | Description                 | Example              |
| --------------- | --------------------------- | -------------------- |
| `FlinchAction`  | Apply flinch status         | Fake Out, Air Slash  |
| `ConfuseAction` | Apply confusion             | Confuse Ray, Swagger |
| `ProtectAction` | Block next move             | Protect, Detect      |
| `DisableAction` | Disable last used move      | Disable              |
| `TauntAction`   | Can only use damaging moves | Taunt                |

#### Special Mechanics

| Action              | Description                           | Example           |
| ------------------- | ------------------------------------- | ----------------- |
| `FaintAction`       | Mark as fainted, trigger death events | HP reaches 0      |
| `TransformAction`   | Copy target's stats/moves             | Transform (Ditto) |
| `SubstituteAction`  | Create HP-based decoy                 | Substitute        |
| `BatonPassAction`   | Switch + keep stat changes            | Baton Pass        |
| `WishAction`        | Delayed heal (2 turns)                | Wish              |
| `FutureSightAction` | Delayed damage (2 turns)              | Future Sight      |

### 4.2 IMoveEffect Catalog

#### Damage Effects

| Effect                | Parameters                 | Description                        |
| --------------------- | -------------------------- | ---------------------------------- |
| `DamageEffect`        | -                          | Standard damage formula            |
| `FixedDamageEffect`   | `int Amount`               | Fixed damage (20, 40, 80)          |
| `LevelDamageEffect`   | -                          | Damage = User's Level              |
| `PercentDamageEffect` | `float Percent`            | % of target's HP (0.5 = 50%)       |
| `MultiHitEffect`      | `int MinHits, int MaxHits` | Hit 2-5 times                      |
| `CriticalRatioEffect` | `int Stages`               | Increased crit chance              |
| `OneHitKOEffect`      | -                          | OHKO if hits (Fissure, Guillotine) |

#### HP Manipulation

| Effect              | Parameters      | Description                            |
| ------------------- | --------------- | -------------------------------------- |
| `RecoilEffect`      | `float Percent` | User takes % of damage dealt           |
| `DrainEffect`       | `float Percent` | User heals % of damage dealt           |
| `HealEffect`        | `float Percent` | Heal % of max HP                       |
| `SacrificialEffect` | -               | User faints (Explosion, Self-Destruct) |
| `PainSplitEffect`   | -               | Average HP of user and target          |

#### Status Application

| Effect           | Parameters                         | Description                   |
| ---------------- | ---------------------------------- | ----------------------------- |
| `BurnEffect`     | `float Chance`                     | Apply Burn                    |
| `ParalyzeEffect` | `float Chance`                     | Apply Paralysis               |
| `PoisonEffect`   | `float Chance, bool BadlyPoisoned` | Apply Poison/Badly Poisoned   |
| `SleepEffect`    | `float Chance`                     | Apply Sleep                   |
| `FreezeEffect`   | `float Chance`                     | Apply Freeze                  |
| `ConfuseEffect`  | `float Chance`                     | Apply Confusion               |
| `FlinchEffect`   | `float Chance`                     | Apply Flinch (only if slower) |

#### Stat Modification

| Effect                  | Parameters                    | Description                     |
| ----------------------- | ----------------------------- | ------------------------------- |
| `StatChangeEffect`      | `Stat, int Stages, bool Self` | Raise/lower stat                |
| `MultiStatChangeEffect` | `Dictionary<Stat, int>`       | Multiple stats at once          |
| `SwaggerEffect`         | -                             | Confuse + raise target's Attack |

#### Field Effects

| Effect            | Parameters                  | Description          |
| ----------------- | --------------------------- | -------------------- |
| `WeatherEffect`   | `WeatherType, int Duration` | Set weather          |
| `TerrainEffect`   | `TerrainType, int Duration` | Set terrain          |
| `HazardEffect`    | `HazardType, int Layers`    | Set entry hazard     |
| `ScreenEffect`    | `ScreenType, int Duration`  | Set defensive screen |
| `TrickRoomEffect` | `int Duration`              | Reverse speed order  |

#### Special Mechanics

| Effect              | Parameters                          | Description                             |
| ------------------- | ----------------------------------- | --------------------------------------- |
| `ChargeEffect`      | `bool Invulnerable, string Message` | 2-turn moves (Fly, Solar Beam)          |
| `ProtectEffect`     | -                                   | Block incoming move                     |
| `CounterEffect`     | `bool Physical`                     | Return 2x damage (Counter, Mirror Coat) |
| `BindEffect`        | `int Turns`                         | Trap + damage (Wrap, Fire Spin)         |
| `LeechSeedEffect`   | -                                   | Drain 1/8 HP each turn                  |
| `DestinyBondEffect` | -                                   | If user faints, faint attacker too      |

### 4.3 Implementation Priority

**Phase 1 (MVP)**: ✅ Complete

-   DamageAction, HealAction, FaintAction
-   ApplyStatusAction, StatChangeAction
-   Basic IMoveEffects (Damage, Status, StatChange)

**Phase 2 (Core Mechanics)**: ✅ Complete

-   RecoilEffect, DrainEffect, MultiHitEffect
-   FlinchEffect, ConfuseEffect
-   WeatherEffect, HazardEffect

**Phase 3 (Advanced)**: ⏳ Planned

-   ChargeEffect (2-turn moves)
-   ProtectEffect, SubstituteEffect
-   TransformEffect, MetronomeEffect

**Phase 4 (Complex)**: ⏳ Planned

-   BatonPassAction, WishEffect
-   CounterEffect, DestinyBondEffect
-   Field effects (Trick Room, Terrain)

---

## 7. Architectural Patterns & Refactoring

> **Note**: A comprehensive refactoring was completed (2024-12-05) following SOLID principles and clean code practices. See `PokemonUltimate.Combat/ANALISIS_COMPLETO_Y_PLAN_IMPLEMENTACION.md` for complete details.

### 7.1 Dependency Injection

All major components now use dependency injection for improved testability and flexibility:

**Key Interfaces**:

-   `IRandomProvider` - Random number generation (replaces static `Random`)
-   `IDamagePipeline` - Damage calculation pipeline
-   `IEndOfTurnProcessor` - End-of-turn effects processing
-   `IBattleTriggerProcessor` - Battle trigger processing
-   `ITargetResolver` - Target selection
-   `IEntryHazardProcessor` - Entry hazard processing
-   `IBattleFieldFactory` - BattleField creation
-   `IBattleQueueFactory` - BattleQueue creation
-   `IBattleStateValidator` - Battle state validation
-   `IBattleLogger` - Battle logging
-   `IBattleEventBus` - Event bus for decoupled communication
-   `IBattleMessageFormatter` - Centralized message formatting

**Example**:

```csharp
public class CombatEngine
{
    private readonly IBattleFieldFactory _battleFieldFactory;
    private readonly IBattleQueueFactory _battleQueueFactory;
    private readonly IRandomProvider _randomProvider;
    private readonly IEndOfTurnProcessor _endOfTurnProcessor;
    // ... other dependencies

    public CombatEngine(
        IBattleFieldFactory battleFieldFactory,
        IBattleQueueFactory battleQueueFactory,
        IRandomProvider randomProvider,
        IEndOfTurnProcessor endOfTurnProcessor,
        // ... other dependencies
    )
    {
        // Dependencies injected via constructor
    }
}
```

### 7.2 Value Objects

Complex state is encapsulated in Value Objects for better organization and immutability:

**Value Objects**:

-   `StatStages` - Manages stat stage modifications (-6 to +6)
-   `DamageTracker` - Tracks damage for Counter/Mirror Coat
-   `ProtectTracker` - Tracks Protect/Detect state
-   `SemiInvulnerableState` - Tracks semi-invulnerable move state
-   `ChargingMoveState` - Tracks charging move state
-   `MoveStateTracker` - Unified tracker for all move states
-   `WeatherState` - Weather condition and duration
-   `TerrainState` - Terrain condition and duration

**Example**:

```csharp
public class BattleSlot
{
    private StatStages _statStages;
    private MoveStateTracker _moveStateTracker;
    private DamageTracker _damageTracker;

    public StatStages StatStages => _statStages;
    public MoveStateTracker MoveState => _moveStateTracker;
    // ...
}
```

### 7.3 Strategy Pattern

Move effects are processed using Strategy Pattern for extensibility:

**Key Components**:

-   `IMoveEffectProcessor` - Interface for effect processors
-   `MoveEffectProcessorRegistry` - Registry for effect processors
-   Implementations: `StatusEffectProcessor`, `StatChangeEffectProcessor`, `RecoilEffectProcessor`, `DrainEffectProcessor`, `FlinchEffectProcessor`, `ProtectEffectProcessor`, `CounterEffectProcessor`, `HealEffectProcessor`

**Example**:

```csharp
public class UseMoveAction : BattleAction
{
    private readonly MoveEffectProcessorRegistry _effectProcessorRegistry;

    private IEnumerable<BattleAction> ProcessEffects(MoveData move)
    {
        foreach (var effect in move.Effects)
        {
            var actions = _effectProcessorRegistry.ProcessEffect(effect, this);
            foreach (var action in actions)
                yield return action;
        }
    }
}
```

### 7.4 Factory Pattern

Object creation is centralized using Factory Pattern:

**Factories**:

-   `DamageContextFactory` - Creates `DamageContext` instances for different scenarios
-   `BattleFieldFactory` - Creates `BattleField` instances
-   `BattleQueueFactory` - Creates `BattleQueue` instances

**Example**:

```csharp
public class DamageContextFactory
{
    public DamageContext CreateForMove(
        BattleSlot attacker,
        BattleSlot defender,
        MoveData move,
        BattleField field)
    {
        return new DamageContext(attacker, defender, move, field);
    }

    public DamageContext CreateForStatusDamage(
        BattleSlot slot,
        int damage,
        BattleField field)
    {
        // Creates appropriate context for status damage
    }
}
```

### 7.5 Event System

Decoupled communication using Event Bus pattern:

**Components**:

-   `IBattleEventBus` - Event bus interface
-   `BattleEventBus` - Event bus implementation
-   Supports subscription/unsubscription for battle events

### 7.6 Logging System

Structured logging for debugging and monitoring:

**Components**:

-   `IBattleLogger` - Logger interface
-   `BattleLogger` - Logger implementation
-   `NullBattleLogger` - Null implementation for tests
-   Logs battle events, errors, and debug information

### 7.7 Validation System

Battle state validation ensures consistency:

**Components**:

-   `IBattleStateValidator` - Validator interface
-   `BattleStateValidator` - Validator implementation
-   Validates slot consistency, stat stages, status counters, party-slot consistency

### 7.8 Extension Methods

Utility methods for common operations:

**Extensions**:

-   `BattleSlotExtensions.IsActive()` - Checks if slot has active Pokemon
-   `DamageCalculationExtensions.EnsureMinimumDamage()` - Ensures minimum damage

### 7.9 Constants Centralization

Magic numbers and strings replaced with constants:

**Constant Classes**:

-   `BattleConstants` - Battle system limits (`MaxTurns`, `MaxQueueIterations`)
-   `StatusConstants` - Status effect constants (`ParalysisSpeedMultiplier`, `ParalysisFullParalysisChance`)
-   `ItemConstants` - Item effect constants (`LeftoversHealDivisor`)
-   `MoveConstants` - Move-related constants (semi-invulnerable move names)

### 7.10 Step-Based Pipeline Architecture

The refactoring introduced a comprehensive step-based pipeline architecture:

**Battle Flow Pipeline** (8 steps):

-   Battle initialization and setup
-   Battle loop execution
-   Battle cleanup and result handling

**Turn Flow Pipeline** (23 unique steps, 34 total):

-   Action collection and sorting
-   Move validation and accuracy checking
-   Damage calculation and application
-   Effect processing (before, during, after moves)
-   Status and switching handling
-   End-of-turn effects

**Damage Pipeline** (11 steps):

-   Base damage calculation
-   Critical hit detection
-   Type effectiveness
-   Weather, terrain, and ability modifiers

**Handler Registry System** (34 handlers):

-   Ability handlers (4)
-   Item handlers (3)
-   Move effect handlers (12)
-   Checker handlers (15)

### 7.11 Refactoring Summary

**Completed Phases (0-13)**:

-   ✅ Step-based pipeline architecture (Battle Flow + Turn Flow)
-   ✅ Dependency Injection throughout
-   ✅ Value Objects for complex state (8 value objects)
-   ✅ Strategy Pattern for move effects
-   ✅ Factory Pattern for object creation
-   ✅ Handler Registry Pattern for abilities/items/effects
-   ✅ Event Bus for decoupled communication
-   ✅ Logging system (BattleLogger, NullBattleLogger)
-   ✅ Message formatting system (BattleMessageFormatter)
-   ✅ Statistics collection system (BattleStatisticsCollector)
-   ✅ Validation system
-   ✅ Extension methods
-   ✅ Constants centralization
-   ✅ Target redirection system
-   ✅ Accumulative effect tracking

**Benefits**:

-   Improved testability (all dependencies injectable, step-by-step execution)
-   Better maintainability (clear separation of concerns, modular steps)
-   Enhanced extensibility (add new steps, handlers, actions easily)
-   Reduced coupling (DI, Event Bus, Handler Registry)
-   Better code organization (Value Objects, Extension Methods, Step Pipelines)
-   Clear execution flow (step-based architecture makes battle flow explicit)

---

## Related Documents

-   **[Use Cases](use_cases.md)** - Scenarios this architecture supports
-   **[Roadmap](roadmap.md)** - Implementation plan for all phases (2.1-2.19)
-   **[Testing](testing.md)** - How to test this architecture
-   **[Code Location](code_location.md)** - Where this is implemented
-   **[Feature 1: Game Data](../1-game-data/architecture.md)** - Pokemon instances used in battles
-   **[Feature 3: Content Expansion](../3-content-expansion/roadmap.md)** - Moves, abilities, items
-   **[Feature 4: Unity Integration](../4-unity-integration/architecture.md)** - Visual battle presentation
-   **[Refactoring Analysis](../../../PokemonUltimate.Combat/ANALISIS_COMPLETO_Y_PLAN_IMPLEMENTACION.md)** - Complete refactoring documentation

**⚠️ Always use numbered feature paths**: `../[N]-[feature-name]/` instead of `../feature-name/`

---

**Last Updated**: 2025-01-XX (Post-Refactoring: 2024-12-05)
